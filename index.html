<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <title>Weather Dashboard</title>
</head>

<body>
    <header class="nav justify-content-center bg-dark">
        <li class="nav-item" href="#" style="color: white">
            <h1>Weather Dashboard</h1>
        </li>
    </header>
    <div class="container">
        <div class="row">
            <div class="col-4">
                <label for="searchInput"><b>Search for a City:</label>
                <div class="input-group">
                    <input id="searchInput" class="form-control" placeholder="City">
                    <button onClick="input(event)" class="btn btn-primary">Search</button>
                </div>
                <div id="saved" class="d-grid gap-2"></div>
            </div><div class="col-8">
                <div class="card">
                    <div class="card-body">
                        <h2 id="userCity" class="card-title"></h2>
                        <p id="temp" class="card-text"></p>
                        <p id="hum" class="card-text"></p>
                        <p id="wind" class="card-text"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div id="forecasted" class="row">
        </div>
    </div>

    <script>
        let cityData
        let x = 0
        let history = Array()
        var name = document.querySelector('#name');
        var temp = document.querySelector('#temp');
        var hum = document.querySelector('#hum');
        var wind = document.querySelector('#wind');
        var forecasted = document.querySelector('#forecasted');
        var today = new Date()
        var dd = today.getDate()
        var mm = today.getMonth()
        var yyyy = today.getFullYear()
        var userHistory = JSON.parse(localStorage.getItem("history") || "[]")
        today = mm + '/' + dd + '/' + yyyy
        var cityForecastData


        for (i=0; i<userHistory.length; i++){
            document.querySelector("#saved").innerHTML += `<button onClick="saved(event, '${userHistory[i]}')" class="btn btn-outline-primary">${userHistory[i]}</button>`
        }

        function input(event) {
            event.preventDefault()
            let cityName = document.querySelector("#searchInput").value
            if (cityName == "") {
                    return
                }
            history[x] = document.querySelector("#searchInput").value; x++;
            document.querySelector("#searchInput").value = ""
            console.log(x)
            document.querySelector("#saved").innerHTML = ""
            for (i = 0; i < history.length; i++) {
                    document.querySelector("#saved").innerHTML += `<button onClick="saved(event, '${history[i]}')" class="btn btn-outline-primary">${history[i]}</button>`
                    localStorage.setItem("history", JSON.stringify(history))
            }
            weather(cityName)
        }
        function saved(event, cityName) {
            event.preventDefault()
            console.log(cityName)
            weather(cityName)
        }

        async function weather(cityName) {
            let fetchUrl = "http://api.openweathermap.org/data/2.5/weather?appid=327fecee9f6fad805256a047aec1915c&q=" + cityName

            console.log(`..fetching from ${fetchUrl}`)
            cityData = await fetch(fetchUrl).then(r => r.json())
                var nameValue = cityData['name']
                var img = cityData['weather'][0]['icon']
                var tempValue = cityData['main']['temp']
                var humValue = cityData['main']['humidity']
                var windValue = cityData['wind']['speed']

                userCity.innerHTML = `${nameValue} (${today}) <img src='http://openweathermap.org/img/wn/${img}@2x.png'>`;
                temp.innerHTML = `Temperature: ${tempValue} K`;
                hum.innerHTML = `Humidity: ${humValue}%`;
                wind.innerHTML = `Wind Speed: ${windValue} MPH`;
                futureWeather(cityName)
        }

        async function futureWeather(cityName){
            let fetchForecastUrl = "http://api.openweathermap.org/data/2.5/forecast?appid=327fecee9f6fad805256a047aec1915c&q=" + cityName
            forecasted.innerHTML = ""

            cityForecastData = await fetch(fetchForecastUrl).then(r => r.json())

                var forecast = cityForecastData['list']
                for (z=0; z<forecast.length; z+=8){
                    var forecastDate = forecast[z]['dt_txt']
                    var forecastImg = forecast[z]['weather'][0]['icon']
                    var forecastTemp = forecast[z]['main']['temp']
                    var forecastHum = forecast[z]['main']['humidity']

                    forecasted.innerHTML += 
                    `<div class="card-body col-1">
                        <h4 class="card-title">${forecastDate}</h4>
                        <img src='http://openweathermap.org/img/wn/${forecastImg}@2x.png'>
                        <p class="card-text">Temperature: ${forecastTemp}K</p>
                        <p class="card-text">Humidity: ${forecastHum}%</p>
                    </div>`
                }


        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
</body>

</html>